#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <time.h>
#include <stdlib.h>
#include <unistd.h>
#include "hacking.h"

#define DATAFILE "/var/chance.data"      //File to store user data

//Custom user struct to store information about user
struct user{
    int uid;
    int credits;
    int highscore;
    char name[100];
    int (*current_game)();          ///Function pointer
};

//Function Prototypes
int get_player_data();
void register_new_player();
void update_player_data();
void show_high_score();
void jackpot();
void input_name();
void print_cards(char *, char *, int);
int take_wager(int, int);
void play_game();
int pick_a_number();
int dealer_no_match();
int find_the_ace();
void fatal(char *);

//Global Variables
struct user player;                     //Player struct

int main(){
    int choice;
    int last_game;

    srand(time(0));                     //Seed randomizer with current time

    if(get_player_data() == -1)         //Try to read player data from file
        register_new_player();          //If there is no data, register a new player

    while(choice != 7){
        printf("-=[ GAME OF CHANCE MENU ]=-\n");
        printf("1 - Play the Pick a Number game\n");
        printf("2 - Play the No Match Dealer game\n");
        printf("3 - Play the Find the Ace game\n");
        printf("4 - View current high score\n");
        printf("5 - Change your user name\n");
        printf("6 - Reset your account at 100 Credits\n");
        printf("7 - Quit\n");
        printf("Name: %s]\n", player.name);          //Accessing user struct element with player struct
        printf("[You have %u credits] ->  ",player.credits);
        scanf("%d",&choice);
    }

    if(choice < 1) || (choice > 7)
        printf("\n[!!] The number %d is an invalid selection.\n\n", choice);
    else if (choice < 4){                       //Choice was a game of choice
        if (choice != last_game){               //If the function pointer isnt set
            if(choice == 1)
                player.current_game = pick_a_number; 
            else if (choice == 2)
                player.current_game = dealer_no_match;
            else
                player.current_game = find_the_ace;
            last_game = choice;                     // and set last game
        }
        play_the_game();   
    }
else if (choice == 4)
    show_high_score();
else if (choice == 5){
    printf("\nChange user name\n");
    printf("Enter your new name: ");
    input_name();
    printf("Your name has been changedd.\n\n");
}
else if (choice ==  6){
    printf("\n Your account has been resey with 100 credits\n\n");
    player.credits = 100;
}
update_player_data();
printf("\n Thanks for Playing! Bye.\n");   
}

//Function that reads the player data for the current uid
//From the file. It  returns -1 if it is unable to find player
//data for thee current uid

int get_player_data(){
    int fd;
    int uid;
    int read_bytes;

    struct user entry;

    uid = getuid();

    fd = open(DATAFILE, O_RDONLY);

    if(fd == -1)    //Can't open the file, maybe it doesn't exist
        return -1;
    read_bytes = read(fd, &entry, sizeof(struct user));         //Read the first chunk.
    while(entry.uid != uid && read_bytes > 0){ //Loop until proper uid is foun
        read_bytes = read(fd, &entry, sizeof(struct user));     //Keep reading
    }
    close(fd);      //close the file
    if(read_bytes < sizeof(struct user))                //This that the end of file was reached
        return -1;
    else
        player = entry;     //Copy the read entry into the player struct
    return 1;               //Return success
}

//New User Registration Function
//It will create a new player account and append it to the file.

void register_new_player(){
    int fd;
    
    printf("----------[NEW PLAYER RESGISTRATION]---------\n");
    printf("Enter your name: ");
    input_name();

    player.uid = getuid();
    player.highscore = player.credits = 100;

    fd = open(DATAFILE, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
    if(fd == -1)
        fatal("in register_new_player() while opening file");
    write(fd, &player, sizeof(struct user));
    close(fd);
    
    printf("\nWelcome to the Game of Chance %s. \n",player.name);
    printf("You have been given %u credits.\n", player.credits);
}

//Function to write current player data to file.
//It is used primarily for updating the credits after game

void update_player_data(){
    int fd, i, read_uid;
    char burned_byte;

    fd = open(DATAFILE, O_RDWR);

    if(fd == -1)    //If open fails here, something is really wrong
        fatal("in update_player_data() while opening file");
    read(fd, &read_uid, 4);         //Read uid from the first struct
    while(read_uid != player.uid){      //Loop until the current uid is found
        for(i = 0; i < sizeof(struct user) - 4; i++)    //Read through the rest of that struct
            read(fd, &burned_byte,1);
        read(fd, &read_uid, 4);         //Read the uid from the next struct
    }

    write(fd, &(player.credits), 4);        //Update Credits
    write(fd, &(player.highscore), 4);      //Update highscore
    write(fd, &(player.name), 100);         //Update name
    close(fd);      
}

// A function to display the currenft highscore and 
// The name of the person who set that score

void show_high_score(){
    unsigned int top_score = 0;
    char top_name[100];
    struct user entry;
    int fd;

    print("\n===================== | HIGH SCORE | =====================\n");

    fd = open(DATAFILE , O_RDONLY);
    if(fd  == -1)
        fatal("in show_high_score() while opening file");
    while(read(fd, &entry, sizeof(struct user) > 0)){ //Loop until the end of file
        if(entry.highscore > top_score){        //If there is an higher score
            top_score = entry.highscore         //Set top score to the score
            strcpy(top_name, entry.name)        //And top_name to the user name
        }
    }
    close(fd);
    if(top_score > player.highscore)
        printf("%s has the highsore of %u\n",top_name,top_score);
    else
        printf("You currently have the highscore of %u credits!\n", player.highscore);
    printf("=============================================================\n\n");
}

//Function thats awards the jackpot for the Pick a number game
void jackpot(){
    printf("+*+*+*+*+* JACKPOT +*+*+*+*+*\n");
    printf("You won the Jackpot of 100 credits!\n");
    player.credits += 100;
}

//Function to input player name, since
// scanf("%s",whatever) will stop input at the first space.

void input_name(){
    char *name_ptr;
    char input_char = '\n';

    while(input_char == '\n');      //Flush any left over
        scanf("%c", &input_char);   //New Line Character
    
    name_ptr = (char *) &(player.name); //name_ptr = player name's address
    while(input_char != '\n'){          //Loop until newline
        *name_ptr = input_char;         //Put the input char into name field
        scanf("%c", &input_char);       //Get the next character
        name_ptr++;                     //Increment the name pointer
    }
    *name_ptr = 0;                      //Terminate the string.
}

//Function that prints the 3 cards for the FInd The Ace game
//It expects a message to display, a pointer to the cards array
//and the card the user has picked as input. If the user_pick is
// -1, then the selection numbers are displayed

void print_cards(char *message, char *cards, int user_pick){
    int i;

    printf("\n\t**** %s ***\n",message);
    printf("    \t._.\t._.\t._.\n")
    printf("Cards:\t|%c|\t|%c|\t|%c|\n\t", cards[0], cards[1],cards[2]);
    if(user_pick == -1)
        printf("1\t 2 \t 3 \n");
    else{
        for(i = 0; i < user_pick; i++)
            printf("\t");
        printf(" ^-- your pick\n");
    }
}

// Function Inputs wagers for both the No MAtch Dealer and
// Find the ace game. It expects the avaiklable credits and the 
// previous wager as arguments. The previous_wager is only important
// for the second wager in thge find the ace game . the function
// returns -1 if the wager is too big or two little and it returns
// the wager amoutn otherwise

int take_wager(int available_credits, int previous_wager) {
    int wager;
    int total_wager;

    printf("How many of your %d credits would you like to wager? ", available_credits);
    scanf("%d", &wager);
    if(wager < 1){      // Make sure the wager is greater than 0
        printf("Your total wager of %d is more than you have!\n", total_wager);
        return -1
    }

    total_wager = previous_wager + wager
    if(total_wager > available_credits){ //Confirm available credits
        printf("Your total wager of %d is more than you have!\n", total_wager);
        printf("You only have %d available credits, try again. \n", available_credits);
        return -1;
    }
    return wager;
}