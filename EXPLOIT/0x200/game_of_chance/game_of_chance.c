#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <time.h>
#include <stdlib.h>
#include <unistd.h>
#include "hacking.h"

#define DATAFILE "/var/chance.data"      //File to store user data

//Custom user struct to store information about user
struct user{
    int uid;
    int credits;
    int highscore;
    char name[100];
    int (*current_game)();          ///Function pointer
};

//Function Prototypes
int get_player_data();
void register_new_player();
void update_player_data();
void show_high_score();
void jackpot();
void input_name();
void print_cards(char *, char *, int);
int take_wager(int, int);
void play_game();
int pick_a_number();
int dealer_no_match();
int find_the_ace();
void fatal(char *);

//Global Variables
struct user player;                     //Player struct

int main(){
    int choice;
    int last_game;

    srand(time(0));                     //Seed randomizer with current time

    if(get_player_data() == -1)         //Try to read player data from file
        register_new_player();          //If there is no data, register a new player

    while(choice != 7){
        printf("-=[ GAME OF CHANCE MENU ]=-\n");
        printf("1 - Play the Pick a Number game\n");
        printf("2 - Play the No Match Dealer game\n");
        printf("3 - Play the Find the Ace game\n");
        printf("4 - View current high score\n");
        printf("5 - Change your user name\n");
        printf("6 - Reset your account at 100 Credits\n");
        printf("7 - Quit\n");
        printf("Name: %s]\n", player.name);          //Accessing user struct element with player struct
        printf("[You have %u credits] ->  ",player.credits);
        scanf("%d",&choice);
    }

    if(choice < 1) || (choice > 7)
        printf("\n[!!] The number %d is an invalid selection.\n\n", choice);
    else if (choice < 4){                       //Choice was a game of choice
        if (choice != last_game){               //If the function pointer isnt set
            if(choice == 1)
                player.current_game = pick_a_number; 
            else if (choice == 2)
                player.current_game = dealer_no_match;
            else
                player.current_game = find_the_ace;
            last_game = choice;                     // and set last game
            
        }
        play_the_game();   
    }
else if (choice == 4)
    show_high_score();
else if (choice == 5){
    printf("\nChange user name\n");
    printf("Enter your new name: ");
    input_name();
    printf("Your name has been changedd.\n\n");
}
else if (choice ==  6){
    printf("\n Your account has been resey with 100 credits\n\n");
    player.credits = 100;
}
update_player_data();
printf("\n Thanks for Playing! Bye.\n");   
}

//Function that reads the player data for the current uid
//From the file. It  returns -1 if it is unable to find player
//data for thee current uid

int get_player_data(){
    int fd;
    int uid;
    int read_bytes;

    struct user entry;

    uid = getuid();

    fd = open(DATAFILE, O_RDONLY);

    if(fd == -1)    //Can't open the file, maybe it doesn't exist
        return -1;
    read_bytes = read(fd, &entry, sizeof(struct user));         //Read the first chunk.
    while(entry.uid != uid && read_bytes > 0){ //Loop until proper uid is foun
        read_bytes = read(fd, &entry, sizeof(struct user));     //Keep reading
    }
    close(fd);      //close the file
    if(read_bytes < sizeof(struct user))                //This that the end of file was reached
        return -1;
    else
        player = entry;     //Copy the read entry into the player struct
    return 1;               //Return success
}

//New User Registration Function
//It will create a new player account and append it to the file.

void register_new_player(){
    int fd;
    
    printf("----------[NEW PLAYER RESGISTRATION]---------\n");
    printf("Enter your name: ");
    input_name();

    player.uid = getuid();
    player.highscore = player.credits = 100;

    fd = open(DATAFILE, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
    if(fd == -1)
        fatal("in register_new_player() while opening file");
    write(fd, &player, sizeof(struct user));
    close(fd);
    
    printf("\nWelcome to the Game of Chance %s. \n",player.name);
    printf("You have been given %u credits.\n", player.credits);
}

//Function to write current player data to file.
//It is used primarily for updating the credits after game

void update_player_data(){
    int fd, i, read_uid;
    char burned_byte;

    fd = open(DATAFILE, O_RDWR)
}