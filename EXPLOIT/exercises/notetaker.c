#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include "hacking.h"

#define BUFFER_SIZE 100
#define FILENAME_SIZE 20

void usage(char *prog_name, char *filename) {
    printf("Usage: %s <data to add to %s>\n", prog_name, filename);
    exit(0);
}

int main(int argc, char *argv[]) {
    int userid, fd;
    char *buffer, *datafile;

    // Allocate memory with error checking
    buffer = (char *)ec_malloc(BUFFER_SIZE);
    datafile = (char *)ec_malloc(FILENAME_SIZE);

    // Safely copy filename
    strncpy(datafile, "/var/notes", FILENAME_SIZE - 1);
    datafile[FILENAME_SIZE - 1] = '\0';

    // Check for command-line arguments
    if (argc < 2) {
        usage(argv[0], datafile);
    }

    // Safely copy input to buffer
    strncpy(buffer, argv[1], BUFFER_SIZE - 1);
    buffer[BUFFER_SIZE - 1] = '\0';

    // Debug output
    printf("[DEBUG] buffer @ %p: '%s'\n", (void *)buffer, buffer);
    printf("[DEBUG] datafile @ %p: '%s'\n", (void *)datafile, datafile);

    // Open file with proper permissions
    fd = open(datafile, O_WRONLY | O_CREAT | O_APPEND, S_IRUSR | S_IWUSR);
    if (fd == -1) {
        fatal("In main() while opening file");
    }
    printf("[DEBUG] file descriptor is %d\n", fd);

    // Get user ID
    userid = getuid();

    // Write data with error checking
    if (write(fd, &userid, sizeof(userid)) == -1) {
        fatal("In main() while writing userid to file");
    }
    if (write(fd, "\n", 1) == -1) {
        fatal("In main() while writing newline after userid");
    }

    if (write(fd, buffer, strlen(buffer)) == -1) {
        fatal("In main() while writing buffer to file");
    }
    if (write(fd, "\n", 1) == -1) {
        fatal("In main() while writing newline after buffer");
    }

    // Close file
    if (close(fd) == -1) {
        fatal("In main() while closing file");
    }

    printf("Note has been saved.\n");

    // Clean up
    free(buffer);
    free(datafile);
    return 0;
}